<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WorldGlow Atlas – Realtime Edition</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
html, body {
  height: 100%;
  margin: 0;
  background: black;
  overflow: hidden;
}

/* 星空背景（追加） */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url("https://raw.githubusercontent.com/ajayns/starfield/master/starfield.png");
  opacity: 0.25;
  z-index: -1;
}

#map {
  width: 100vw;
  height: 100vh;
}

/* 光る点（ユーザー位置 & 他ユーザー） */
.glow {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(0,255,255,0.9);
  box-shadow: 0 0 12px rgba(0,255,255,1), 0 0 22px rgba(0,255,255,0.8);
  animation: pulse 2.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { transform: scale(0.8); opacity: 0.6; }
  50% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(0.8); opacity: 0.6; }
}

/* 国名ホバーツールチップ */
.leaflet-tooltip.my-labels {
  background: rgba(0,0,0,0.6);
  color: cyan;
  border: 1px solid cyan;
  font-size: 14px;
  padding: 3px 6px;
  border-radius: 4px;
  opacity: 0.8;
}
</style>
</head>

<body>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase モジュール -->
<script type="module">

/* ============================
   ① Firebase 初期化
============================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ★★★《ここにあなたの firebaseConfig を貼る》★★★ */
const firebaseConfig = {
  // ← コピペした内容に置き換える！
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ============================
   ② Leaflet 地図セッティング
============================ */

const map = L.map("map", {
  zoomControl: false,
  minZoom: 2,
  maxZoom: 9,
  worldCopyJump: true,
  inertia: true,
  inertiaDeceleration: 1800
}).setView([20, 0], 2);

/* CartoDB Dark Matter */
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { attribution: "&copy; CartoDB", noWrap: false }
).addTo(map);

/* ============================
   ③ ユーザー位置を取得 → Firebase へ保存
============================ */

function saveUserPosition(lat, lng) {
  const uid = "user_" + crypto.randomUUID(); // 一時的な匿名ID
  set(ref(db, "users/" + uid), {
    lat: lat,
    lng: lng,
    updated: Date.now()
  });
}

navigator.geolocation.getCurrentPosition(
  (pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    saveUserPosition(lat, lng);
  },
  () => console.warn("位置情報が許可されませんでした。")
);

/* ============================
   ④ Firebase 上の全ユーザーをリアルタイム表示
============================ */

const markers = {};

onValue(ref(db, "users"), (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  Object.keys(data).forEach((uid) => {
    const u = data[uid];

    if (!markers[uid]) {
      const glow = L.divIcon({
        className: "",
        html: `<div class="glow"></div>`,
        iconSize: [20,20],
        iconAnchor: [10,10]
      });

      markers[uid] = L.marker([u.lat, u.lng], { icon: glow }).addTo(map);
    } else {
      markers[uid].setLatLng([u.lat, u.lng]);
    }
  });
});

</script>
</body>
</html>
