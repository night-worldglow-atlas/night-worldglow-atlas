<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Night WorldGlow Atlas – Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
    }
    #map {
      position: fixed;
      inset: 0;
    }

    /* 光るドット */
    .glow-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      position: relative;
      background: radial-gradient(circle, #ffffff 0%, #e6ffff 35%, rgba(0,255,255,0) 70%);
      animation: pulse 3.5s ease-in-out infinite;
      will-change: transform, opacity;
    }
    .glow-dot::before {
      content: "";
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0,255,255,0.7) 0%, rgba(0,255,255,0.04) 60%, transparent 70%);
      filter: blur(6px);
      opacity: 0.9;
      animation: breathe 5.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%   { transform: scale(0.8); opacity: 0.6; }
      50%  { transform: scale(1.3); opacity: 1;   }
      100% { transform: scale(0.8); opacity: 0.6; }
    }
    @keyframes breathe {
      0%   { opacity: 0.7; filter: blur(5px); }
      50%  { opacity: 1.0; filter: blur(9px); }
      100% { opacity: 0.7; filter: blur(5px); }
    }

    /* 都市名ツールチップ */
    .hub-tooltip {
      background: rgba(8,16,32,0.92);
      color: #e6f3ff;
      padding: 3px 6px;
      font-size: 11px;
      border: 1px solid rgba(120,210,255,0.9);
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(80,180,255,0.45);
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .18s ease-out, transform .18s ease-out;
    }
    .hub-tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div id="map" aria-label="Night WorldGlow Atlas"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase v8（app + database） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    /* ===========================
       1. Firebase 初期化
    =========================== */

    const firebaseConfig = {
  apiKey: "AIzaSyD3xjpt8d5drHIMzz-vEaxGr5u1rIt6wic",
  authDomain: "night-worldglow-atlas.firebaseapp.com",
  databaseURL: "https://night-worldglow-atlas-default-rtdb.firebaseio.com",
  projectId: "night-worldglow-atlas",
  storageBucket: "night-worldglow-atlas.firebasestorage.app",
  messagingSenderId: "642783531828",
  appId: "1:642783531828:web:9652fcae298ddff8f90b61",
  measurementId: "G-6W4TJ7H70B"
};


    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log("Firebase initialized");
    } catch (e) {
      console.warn("Firebase init error:", e);
      db = null; // 失敗しても地図は動かす
    }

    /* ===========================
       2. Leaflet 地図セットアップ
    =========================== */

    const map = L.map("map", {
      zoomControl: false,
      attributionControl: false,
      worldCopyJump: true,
      minZoom: 2,
      maxZoom: 9
    }).setView([20, 0], 2.4);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 19 }
    ).addTo(map);

    function glowMarker(lat, lng) {
      const icon = L.divIcon({
        className: "",
        html: '<div class="glow-dot"></div>',
        iconSize: [16,16],
        iconAnchor: [8,8]
      });
      return L.marker([lat, lng], { icon }).addTo(map);
    }

    /* 都市ラベル（ダミー光ではなく、マウスオーバー用） */
    const hubs = [
      {name:"Tokyo, Japan", lat:35.68, lng:139.76},
      {name:"New York, USA", lat:40.71, lng:-74.00},
      {name:"London, UK", lat:51.50, lng:-0.12},
      {name:"Paris, France", lat:48.85, lng:2.35},
      {name:"Berlin, Germany", lat:52.52, lng:13.40},
      {name:"Sydney, Australia", lat:-33.86, lng:151.20}
    ];

    function addHubLabels() {
      hubs.forEach(h => {
        const m = L.circleMarker([h.lat, h.lng], {
          radius: 10,
          stroke: false,
          fill: false,
          interactive: true
        }).addTo(map);
        m.bindTooltip(h.name, {
          className: "hub-tooltip",
          direction: "top",
          offset: [0,-6]
        });
        m.on("mouseover", () => {
          m.openTooltip();
          const el = m.getTooltip()?.getElement();
          if (el) el.classList.add("visible");
        });
        m.on("mouseout", () => {
          const el = m.getTooltip()?.getElement();
          if (el) el.classList.remove("visible");
        });
      });
    }

    addHubLabels();

    /* ===========================
       3. 現在地を取得して Firebase に送信
    =========================== */

    const userIdKey = "nwgaClientId";
    let clientId = localStorage.getItem(userIdKey);
    if (!clientId) {
      clientId = "u_" + Math.random().toString(36).slice(2);
      localStorage.setItem(userIdKey, clientId);
    }

    function sendLocation(lat, lng) {
      if (!db) return; // Firebaseがダメでも地図だけ動かす
      db.ref("users/" + clientId).set({
        lat: lat,
        lng: lng,
        updatedAt: Date.now()
      });
    }

    function initGeolocation() {
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported.");
        const lat = 35.68, lng = 139.76; // 東京
        map.setView([lat, lng], 4, { animate:true });
        glowMarker(lat, lng);
        sendLocation(lat, lng);
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setView([lat, lng], 4, { animate:true });
          glowMarker(lat, lng);
          sendLocation(lat, lng);
        },
        err => {
          console.warn("Geolocation error:", err);
          const lat = 51.50, lng = -0.12; // ロンドン
          map.setView([lat, lng], 3, { animate:true });
          glowMarker(lat, lng);
          sendLocation(lat, lng);
        },
        { enableHighAccuracy:false, timeout:6000, maximumAge:30000 }
      );
    }

    initGeolocation();

    /* ===========================
       4. Firebase上の他ユーザーをリアルタイム表示
    =========================== */

    const markersById = {};

    function subscribeUsers() {
      if (!db) return;
      const refUsers = db.ref("users");
      refUsers.on("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;

        const now = Date.now();

        Object.keys(data).forEach(id => {
          const u = data[id];
          if (!u || typeof u.lat !== "number" || typeof u.lng !== "number") return;

          // 30分以上古いデータは無視
          if (u.updatedAt && (now - u.updatedAt > 30 * 60 * 1000)) {
            if (markersById[id]) {
              map.removeLayer(markersById[id]);
              delete markersById[id];
            }
            return;
          }

          if (id === clientId) {
            // 自分のマーカーは initGeolocation で描画済みなのでスキップ
            return;
          }

          if (markersById[id]) {
            markersById[id].setLatLng([u.lat, u.lng]);
          } else {
            markersById[id] = glowMarker(u.lat, u.lng);
          }
        });
      });
    }

    subscribeUsers();

    // ページを閉じる時に自分のデータを消す（お掃除）
    window.addEventListener("beforeunload", () => {
      if (!db) return;
      db.ref("users/" + clientId).remove();
    });
  </script>
</body>
</html>
