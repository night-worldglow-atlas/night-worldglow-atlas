<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>World Glow – Edge Compatible Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { margin:0; height:100%; background:#000; }
    #map { position:fixed; inset:0; }

    .leaflet-control-zoom, .leaflet-control-attribution { display:none!important; }
    .leaflet-container { background:#000; transition:transform .4s ease-in-out; }

    /* 発光ドット */
    .glow-dot {
      width:14px; height:14px; border-radius:50%;
      position:relative;
      background:radial-gradient(circle,#fff 0%,#e6f0ff 35%,rgba(255,255,255,0) 70%);
      animation:pulse 4.8s ease-in-out infinite;
      will-change:transform,opacity;
    }
    .glow-dot::before {
      content:""; position:absolute; inset:-10px; border-radius:50%;
      background:radial-gradient(circle,rgba(0,255,255,.65) 0%,rgba(0,255,255,.06) 60%,transparent 70%);
      filter:blur(6px);
      animation:breathe 6.5s ease-in-out infinite;
      opacity:.85;
    }

    .c-cyan::before   { background:radial-gradient(circle,rgba(0,255,255,.65) 0%,rgba(0,255,255,.06) 60%,transparent 70%); }
    .c-orange::before { background:radial-gradient(circle,rgba(255,170,0,.6) 0%,rgba(255,170,0,.06) 60%,transparent 70%); }
    .c-violet::before { background:radial-gradient(circle,rgba(170,120,255,.6) 0%,rgba(170,120,255,.06) 60%,transparent 70%); }
    .c-mint::before   { background:radial-gradient(circle,rgba(120,255,200,.6) 0%,rgba(120,255,200,.06) 60%,transparent 70%); }

    .s1 { transform:scale(.9); }
    .s2 { transform:scale(1.1); }
    .s3 { transform:scale(1.3); }

    @keyframes pulse {
      0% { transform:scale(.85); opacity:.65; }
      50%{ transform:scale(1.15); opacity:1; }
      100%{ transform:scale(.85); opacity:.65; }
    }
    @keyframes breathe {
      0%{ opacity:.7; filter:blur(5px); }
      50%{ opacity:1; filter:blur(9px); }
      100%{ opacity:.7; filter:blur(5px); }
    }

    /* 都市名ツールチップ */
    .hub-tooltip {
      background:rgba(8,16,32,.92);
      color:#e6f3ff;
      padding:3px 6px;
      font-size:11px;
      border:1px solid rgba(120,210,255,.9);
      border-radius:4px;
      box-shadow:0 0 8px rgba(80,180,255,.45);
      opacity:0;
      transform:translateY(4px);
      transition:opacity .18s ease-out, transform .18s ease-out;
    }
    .hub-tooltip.visible {
      opacity:1;
      transform:translateY(0);
    }
  </style>
</head>
<body>
  <div id="map" aria-label="World Glow Map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ========== AudioContext（Edge対応：ユーザー操作まで遅延） ========== */
    let audioCtx = null;
    let audioArmed = false;

    function armAudio() {
      if (audioArmed) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;
      audioCtx = new AC();
      audioArmed = true;
    }

    function playZoomBreath() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;

      const breathOsc = audioCtx.createOscillator();
      breathOsc.type='sine';
      breathOsc.frequency.value = 58;

      const breathGain = audioCtx.createGain();
      breathGain.gain.setValueAtTime(0, now);
      breathGain.gain.linearRampToValueAtTime(0.18, now+0.5);
      breathGain.gain.linearRampToValueAtTime(0.0, now+2.0);

      const lp = audioCtx.createBiquadFilter();
      lp.type='lowpass';
      lp.frequency.value = 800;

      const lfo = audioCtx.createOscillator();
      lfo.type='sine';
      lfo.frequency.value = 0.25;
      const lfoGain = audioCtx.createGain();
      lfoGain.gain.value = 220;
      lfo.connect(lfoGain).connect(lp.frequency);

      breathOsc.connect(lp).connect(breathGain);

      const pad1 = audioCtx.createOscillator();
      const pad2 = audioCtx.createOscillator();
      pad1.type='triangle'; pad2.type='triangle';
      pad1.frequency.value = 440; pad2.frequency.value = 444;

      const padGain = audioCtx.createGain();
      padGain.gain.setValueAtTime(0, now);
      padGain.gain.linearRampToValueAtTime(0.08, now+0.08);
      padGain.gain.exponentialRampToValueAtTime(0.001, now+0.6);

      const delay = audioCtx.createDelay(0.4);
      delay.delayTime.value = 0.22;
      const fb = audioCtx.createGain();
      fb.gain.value = 0.25;
      delay.connect(fb).connect(delay);

      const master = audioCtx.createGain();
      master.gain.value = 0.6;

      breathGain.connect(master);
      pad1.connect(padGain).connect(delay);
      pad2.connect(padGain).connect(delay);
      delay.connect(master);
      master.connect(audioCtx.destination);

      lfo.start(now);
      breathOsc.start(now);
      pad1.start(now);
      pad2.start(now);

      breathOsc.stop(now+2.2);
      pad1.stop(now+0.7);
      pad2.stop(now+0.7);
      lfo.stop(now+2.3);
    }

    function playZoomClick() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type='square';
      osc.frequency.value = 520 + Math.random()*160;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.12, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.22);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now+0.25);
    }

    /* ===================== 地図初期化 ===================== */
    const map = L.map("map", {
      zoomControl:false,
      attributionControl:false,
      worldCopyJump:true,
      minZoom:2,
      maxZoom:9,
      zoomSnap:0.25,
      zoomDelta:0.25,
      inertia:true
    }).setView([20,0], 2.4);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { subdomains:"abcd", maxZoom:19 }
    ).addTo(map);

    function glow(lat,lng,cls="") {
      const icon = L.divIcon({
        className:"",
        html:`<div class="glow-dot ${cls}"></div>`,
        iconSize:[14,14],
        iconAnchor:[7,7]
      });
      return L.marker([lat,lng], {icon}).addTo(map);
    }

    /* ===================== 現在地取得 ===================== */
    function addCurrentLocation() {
      if (!navigator.geolocation) {
        glow(35.68,139.76,"c-cyan s2");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const {latitude,longitude}=pos.coords;
          map.setView([latitude,longitude],4,{animate:true});
          glow(latitude,longitude,"c-cyan s3");
        },
        err=>{
          console.warn("Geolocation error:",err);
          map.setView([51.50,-0.12],3,{animate:true});
          glow(51.50,-0.12,"c-violet s2");
        },
        { enableHighAccuracy:false, timeout:6000, maximumAge:30000 }
      );
    }

    /* ===================== 他ユーザーの光 & ラベル ===================== */
    const hubs = [
      {name:"Tokyo, Japan", lat:35.68, lng:139.76},
      {name:"New York, USA", lat:40.71, lng:-74.00},
      {name:"London, UK", lat:51.50, lng:-0.12},
      {name:"Paris, France", lat:48.85, lng:2.35},
      {name:"Berlin, Germany", lat:52.52, lng:13.40},
      {name:"Moscow, Russia", lat:55.75, lng:37.61},
      {name:"Dubai, UAE", lat:25.20, lng:55.27},
      {name:"Mumbai, India", lat:19.07, lng:72.87},
      {name:"Singapore", lat:1.35, lng:103.81},
      {name:"Sydney, Australia", lat:-33.86, lng:151.20},
      {name:"Seoul, South Korea", lat:37.56, lng:126.97},
      {name:"Shanghai, China", lat:31.23, lng:121.47},
      {name:"Bangkok, Thailand", lat:13.75, lng:100.50},
      {name:"Jakarta, Indonesia", lat:-6.20, lng:106.84},
      {name:"Los Angeles, USA", lat:34.05, lng:-118.24},
      {name:"San Francisco, USA", lat:37.77, lng:-122.42},
      {name:"Mexico City, Mexico", lat:19.43, lng:-99.13},
      {name:"Rio de Janeiro, Brazil", lat:-22.90, lng:-43.17},
      {name:"Johannesburg, S. Africa", lat:-26.20, lng:28.04},
      {name:"Cairo, Egypt", lat:30.04, lng:31.23}
    ];

    const colorClasses=["c-cyan","c-orange","c-violet","c-mint"];
    const sizeClasses=["s1","s2","s3"];

    function seedLights(n=25){
      for(let i=0;i<n;i++){
        const base=hubs[Math.floor(Math.random()*hubs.length)];
        const lat=base.lat+(Math.random()-.5)*1.0;
        const lng=base.lng+(Math.random()-.5)*1.0;
        glow(lat,lng,`${colorClasses[Math.floor(Math.random()*4)]} ${sizeClasses[Math.floor(Math.random()*3)]}`);
      }
    }

    function addHubLabels() {
      hubs.forEach(h=>{
        const m=L.circleMarker([h.lat,h.lng],{
          radius:10, stroke:false, fill:false, interactive:true
        }).addTo(map);
        m.bindTooltip(h.name,{
          className:"hub-tooltip",
          direction:"top",
          offset:[0,-6]
        });
        m.on("mouseover",()=>{
          m.openTooltip();
          const el=m.getTooltip()?.getElement();
          if(el) el.classList.add("visible");
        });
        m.on("mouseout",()=>{
          const el=m.getTooltip()?.getElement();
          if(el) el.classList.remove("visible");
        });
      });
    }

    /* ===================== ズームイベント（サウンド＋アニメ） ===================== */
    map.on("click",armAudio);
    map.on("zoomstart",()=>{
      armAudio();
      document.querySelector(".leaflet-container").style.transition="transform .55s ease-out";
      playZoomBreath();
    });
    map.on("zoomend",()=>{
      document.querySelector(".leaflet-container").style.transition="transform .35s ease-in";
      playZoomClick();
    });

    /* 最大ズーム時だけ上下を ±60° に制限 */
    function clampLat(lat,min,max){return Math.max(min,Math.min(max,lat));}
    map.on("moveend",()=>{
      const z=map.getZoom();
      if(z>=9){
        const c=map.getCenter();
        const lat=clampLat(c.lat,-60,60);
        if(lat!==c.lat){
          map.panTo([lat,c.lng],{animate:false});
        }
      }
    });

    /* ===================== 起動 ===================== */
    window.onload=()=>{
      addCurrentLocation();
      addHubLabels();
    };
  </script>
</body>
</html>
